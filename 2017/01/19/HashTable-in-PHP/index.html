<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> HashTable in PHP · ztz.send(:later)</title><meta name="description" content="HashTable in PHP - ztz"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://ztz.me/atom.xml" title="ztz.send(:later)"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/1260091985" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/zt2" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HashTable in PHP</h1><div class="post-info">Jan 19, 2017</div><div class="post-content"><h2 id="什么是-HashTable"><a href="#什么是-HashTable" class="headerlink" title="什么是 HashTable"></a>什么是 HashTable</h2><p><code>HashTable</code>即是哈希表，被用在动态语言中作为一种高效的存储结构。<code>HashTable</code>使用<code>Key</code>来索引<code>Value</code></p>
<h2 id="HashTable-in-PHP-5"><a href="#HashTable-in-PHP-5" class="headerlink" title="HashTable in PHP 5"></a>HashTable in PHP 5</h2><p><code>HashTable</code>的实现主要是在<code>Zend/</code>目录下的<code>zend.h</code>和<code>zend.c</code>文件中，以<code>PHP 5.4</code>为例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> bucket &#123;</div><div class="line">    ulong h;                        <span class="comment">/* Used for numeric indexing */</span></div><div class="line">    uint nKeyLength;</div><div class="line">    <span class="keyword">void</span> *pData;</div><div class="line">    <span class="keyword">void</span> *pDataPtr;</div><div class="line">    <span class="keyword">struct</span> bucket *pListNext;</div><div class="line">    <span class="keyword">struct</span> bucket *pListLast;</div><div class="line">    <span class="keyword">struct</span> bucket *pNext;</div><div class="line">    <span class="keyword">struct</span> bucket *pLast;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *arKey;</div><div class="line">&#125; Bucket;</div></pre></td></tr></table></figure>
<p>首先定义了用于储存数据的<code>bucket</code>，其中各字段的意义分别如下：</p>
<ul>
<li><code>ulong h</code>就是所谓的<code>hash</code></li>
<li><code>uint nKeyLength</code>则是原始<code>Key</code>长度</li>
<li><code>void *pData</code>指向数据的副本，但如果数据是指针的话，则指向<code>void *DataPtr</code></li>
<li><code>void *DataPtr</code>在数据是指针时，指向该指针</li>
<li><code>struct bucket *pListNext</code>指向整个<code>hash</code>表的下一个元素</li>
<li><code>struct bucket *pListLast</code>则指向整个<code>hash</code>表的上一个元素</li>
<li><code>struct bucket *pNext</code>指向存放在同一个<code>hash bucket</code>里的下一个元素</li>
<li><code>struct bucket *pLast</code>指向存放在同一个<code>hash bucket</code>里的上一个元素</li>
</ul>
<p>而<code>HashTable</code>则是用来存储和索引<code>Bucket</code>的数据结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _hashtable &#123;</div><div class="line">    uint nTableSize;</div><div class="line">    uint nTableMask;</div><div class="line">    uint nNumOfElements;</div><div class="line">    ulong nNextFreeElement;</div><div class="line">    Bucket *pInternalPointer;    <span class="comment">/* Used for element traversal */</span></div><div class="line">    Bucket *pListHead;</div><div class="line">    Bucket *pListTail;</div><div class="line">    Bucket **arBuckets;</div><div class="line">    <span class="keyword">dtor_func_t</span> pDestructor;</div><div class="line">    zend_bool persistent;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> nApplyCount;</div><div class="line">    zend_bool bApplyProtection;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_DEBUG</span></div><div class="line">    <span class="keyword">int</span> inconsistent;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125; HashTable;</div></pre></td></tr></table></figure>
<p>各字段的意义分别如下：</p>
<ul>
<li><code>uint nTableSize</code>表示整个<code>HashTable</code>的大小，最小为<code>8</code></li>
<li><code>uint nTableMask</code>用来计算索引，保证最终索引不超过<code>nTableSize</code></li>
<li><code>uint nNumOfElements</code>保存目前整个<code>HashTable</code>中存放的数据数目，一些统计类函数如<code>count()</code>会直接访问该变量从而免去统计时间</li>
<li><code>ulong nNextFreeElement</code>保存下一个数字索引的位置</li>
<li><code>Bucket *pInternalPointer</code>保存了当前遍历的指针，这也是为什么<code>foreach</code>速度比<code>for</code>快的原因</li>
<li><code>Bucket *pListHead</code>指向整个<code>Bucket List</code>的第一个元素</li>
<li><code>Bucket *pListTail</code>则指向整个<code>Bucket List</code>的最后一个有效元素</li>
<li><code>Bucket **arBuckets</code>指向存储<code>Bucket</code>的数组</li>
<li><code>dtor_func_t pDestructor</code>用于删除元素时执行的回调函数，用于释放资源</li>
<li><code>zend_bool persistent</code>表示元素内存分配是否为持久化分配，若为持久化分配则调用系统内存分配函数，否则调用php内存分配函数</li>
<li><code>unsigned char nApplyCount</code>标记当前<code>hash Bucket</code>被递归访问的次数（防止多次递归）</li>
<li><code>zend_bool bApplyProtection</code>标记当前hash桶允许不允许多次访问，不允许时，最多只能递归3次</li>
</ul>
<p>看完数据结构的定义以后，来看相关处理方法的定义，首先将相关方法进行一个简单的分类</p>
<h3 id="初始化-销毁"><a href="#初始化-销毁" class="headerlink" title="初始化/销毁"></a>初始化/销毁</h3><p>声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* startup/shutdown */</span></div><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_init(HashTable *ht, uint nSize, <span class="keyword">hash_func_t</span> pHashFunction, <span class="keyword">dtor_func_t</span> pDestructor, zend_bool persistent ZEND_FILE_LINE_DC);</div><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_init_ex(HashTable *ht, uint nSize, <span class="keyword">hash_func_t</span> pHashFunction, <span class="keyword">dtor_func_t</span> pDestructor, zend_bool persistent, zend_bool bApplyProtection ZEND_FILE_LINE_DC);</div><div class="line"><span class="function">ZEND_API <span class="keyword">void</span> <span class="title">zend_hash_destroy</span><span class="params">(HashTable *ht)</span></span>;</div><div class="line"><span class="function">ZEND_API <span class="keyword">void</span> <span class="title">zend_hash_clean</span><span class="params">(HashTable *ht)</span></span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zend_hash_init(ht, nSize, pHashFunction, pDestructor, persistent)                        _zend_hash_init((ht), (nSize), (pHashFunction), (pDestructor), (persistent) ZEND_FILE_LINE_CC)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zend_hash_init_ex(ht, nSize, pHashFunction, pDestructor, persistent, bApplyProtection)        _zend_hash_init_ex((ht), (nSize), (pHashFunction), (pDestructor), (persistent), (bApplyProtection) ZEND_FILE_LINE_CC)</span></div></pre></td></tr></table></figure>
<p>基本上按照初始化，销毁，清空，每个功能建立了一个函数</p>
<p>下面来看具体的定义</p>
<p>初始化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_init(HashTable *ht, uint nSize, <span class="keyword">hash_func_t</span> pHashFunction, <span class="keyword">dtor_func_t</span> pDestructor, zend_bool persistent ZEND_FILE_LINE_DC)</div><div class="line">&#123;</div><div class="line">    uint i = <span class="number">3</span>;</div><div class="line"></div><div class="line">    SET_INCONSISTENT(HT_OK);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (nSize &gt;= <span class="number">0x80000000</span>) &#123;</div><div class="line">        <span class="comment">/* prevent overflow */</span></div><div class="line">        ht-&gt;nTableSize = <span class="number">0x80000000</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">while</span> ((<span class="number">1U</span> &lt;&lt; i) &lt; nSize) &#123;</div><div class="line">            i++;</div><div class="line">        &#125;</div><div class="line">        ht-&gt;nTableSize = <span class="number">1</span> &lt;&lt; i;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ht-&gt;nTableMask = <span class="number">0</span>;    <span class="comment">/* 0 means that ht-&gt;arBuckets is uninitialized */</span></div><div class="line">    ht-&gt;pDestructor = pDestructor;</div><div class="line">    ht-&gt;arBuckets = (Bucket**)&amp;uninitialized_bucket;</div><div class="line">    ht-&gt;pListHead = <span class="literal">NULL</span>;</div><div class="line">    ht-&gt;pListTail = <span class="literal">NULL</span>;</div><div class="line">    ht-&gt;nNumOfElements = <span class="number">0</span>;</div><div class="line">    ht-&gt;nNextFreeElement = <span class="number">0</span>;</div><div class="line">    ht-&gt;pInternalPointer = <span class="literal">NULL</span>;</div><div class="line">    ht-&gt;persistent = persistent;</div><div class="line">    ht-&gt;nApplyCount = <span class="number">0</span>;</div><div class="line">    ht-&gt;bApplyProtection = <span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先，有一个奇怪的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uint i = <span class="number">3</span>;</div></pre></td></tr></table></figure>
<p>为了保证最小大小为<code>8</code>，所以这里要设置<code>i = 3</code>，因为<code>1</code>左移<code>3</code>位正好是<code>8</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> ((<span class="number">1U</span> &lt;&lt; i) &lt; nSize) &#123;</div><div class="line">    i++;</div><div class="line">&#125;</div><div class="line">ht-&gt;nTableSize = <span class="number">1</span> &lt;&lt; i;</div></pre></td></tr></table></figure>
<p>这段则是动态调整大小，以适应最大大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ht-&gt;nTableMask = <span class="number">0</span>;    <span class="comment">/* 0 means that ht-&gt;arBuckets is uninitialized */</span></div><div class="line">ht-&gt;pDestructor = pDestructor;</div><div class="line">ht-&gt;arBuckets = (Bucket**)&amp;uninitialized_bucket;</div><div class="line">ht-&gt;pListHead = <span class="literal">NULL</span>;</div><div class="line">ht-&gt;pListTail = <span class="literal">NULL</span>;</div><div class="line">ht-&gt;nNumOfElements = <span class="number">0</span>;</div><div class="line">ht-&gt;nNextFreeElement = <span class="number">0</span>;</div><div class="line">ht-&gt;pInternalPointer = <span class="literal">NULL</span>;</div><div class="line">ht-&gt;persistent = persistent;</div><div class="line">ht-&gt;nApplyCount = <span class="number">0</span>;</div><div class="line">ht-&gt;bApplyProtection = <span class="number">1</span>;</div></pre></td></tr></table></figure>
<p>这就是正常的初始化了，由于<code>HashTable</code>里面还没有任何数据，所以<code>ht-&gt;arBuckets = (Bucket**)&amp;uninitialized_bucket</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> Bucket *uninitialized_bucket = <span class="literal">NULL</span>;</div></pre></td></tr></table></figure>
<p><code>uninitialized_bucket</code>则早已定义成了<code>NULL</code></p>
<p>下面看<code>_zend_hash_init_ex</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_init_ex(HashTable *ht, uint nSize, <span class="keyword">hash_func_t</span> pHashFunction, <span class="keyword">dtor_func_t</span> pDestructor, zend_bool persistent, zend_bool bApplyProtection ZEND_FILE_LINE_DC)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> retval = _zend_hash_init(ht, nSize, pHashFunction, pDestructor, persistent ZEND_FILE_LINE_CC);</div><div class="line"></div><div class="line">    ht-&gt;bApplyProtection = bApplyProtection;</div><div class="line">    <span class="keyword">return</span> retval;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>_zend_hash_init_ex</code>其实就是一个wrapper, 多了一个<code>bApplyProtection</code>可以设置</p>
<p>下面看<code>zend_hash_destroy</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function">ZEND_API <span class="keyword">void</span> <span class="title">zend_hash_destroy</span><span class="params">(HashTable *ht)</span></span></div><div class="line">&#123;</div><div class="line">    Bucket *p, *q;</div><div class="line"></div><div class="line">    IS_CONSISTENT(ht);</div><div class="line"></div><div class="line">    SET_INCONSISTENT(HT_IS_DESTROYING);</div><div class="line"></div><div class="line">    p = ht-&gt;pListHead;</div><div class="line">    <span class="keyword">while</span> (p != <span class="literal">NULL</span>) &#123;</div><div class="line">        q = p;</div><div class="line">        p = p-&gt;pListNext;</div><div class="line">        <span class="keyword">if</span> (ht-&gt;pDestructor) &#123;</div><div class="line">            ht-&gt;pDestructor(q-&gt;pData);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (q-&gt;pData != &amp;q-&gt;pDataPtr) &#123;</div><div class="line">            pefree(q-&gt;pData, ht-&gt;persistent);</div><div class="line">        &#125;</div><div class="line">        pefree(q, ht-&gt;persistent);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (ht-&gt;nTableMask) &#123;</div><div class="line">        pefree(ht-&gt;arBuckets, ht-&gt;persistent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SET_INCONSISTENT(HT_DESTROYED);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对<code>HashTable</code>里的元素进行遍历，依次调用<code>ht-&gt;pDestructor</code>进行销毁，然后释放内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (ht-&gt;pDestructor) &#123;</div><div class="line">    ht-&gt;pDestructor(q-&gt;pData);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (q-&gt;pData != &amp;q-&gt;pDataPtr) &#123;</div><div class="line">    pefree(q-&gt;pData, ht-&gt;persistent);</div><div class="line">&#125;</div><div class="line">pefree(q, ht-&gt;persistent);</div></pre></td></tr></table></figure>
<p>最后销毁<code>ht-&gt;arBuckets</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (ht-&gt;nTableMask) &#123;</div><div class="line">    pefree(ht-&gt;arBuckets, ht-&gt;persistent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面看<code>zend_hash_clean</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function">ZEND_API <span class="keyword">void</span> <span class="title">zend_hash_clean</span><span class="params">(HashTable *ht)</span></span></div><div class="line">&#123;</div><div class="line">    Bucket *p, *q;</div><div class="line"></div><div class="line">    IS_CONSISTENT(ht);</div><div class="line"></div><div class="line">    p = ht-&gt;pListHead;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ht-&gt;nTableMask) &#123;</div><div class="line">        <span class="built_in">memset</span>(ht-&gt;arBuckets, <span class="number">0</span>, ht-&gt;nTableSize*<span class="keyword">sizeof</span>(Bucket *));</div><div class="line">    &#125;</div><div class="line">    ht-&gt;pListHead = <span class="literal">NULL</span>;</div><div class="line">    ht-&gt;pListTail = <span class="literal">NULL</span>;</div><div class="line">    ht-&gt;nNumOfElements = <span class="number">0</span>;</div><div class="line">    ht-&gt;nNextFreeElement = <span class="number">0</span>;</div><div class="line">    ht-&gt;pInternalPointer = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (p != <span class="literal">NULL</span>) &#123;</div><div class="line">        q = p;</div><div class="line">        p = p-&gt;pListNext;</div><div class="line">        <span class="keyword">if</span> (ht-&gt;pDestructor) &#123;</div><div class="line">            ht-&gt;pDestructor(q-&gt;pData);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (q-&gt;pData != &amp;q-&gt;pDataPtr) &#123;</div><div class="line">            pefree(q-&gt;pData, ht-&gt;persistent);</div><div class="line">        &#125;</div><div class="line">        pefree(q, ht-&gt;persistent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先获取<code>HashTable</code>的首元素</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">p = ht-&gt;pListHead;</div></pre></td></tr></table></figure>
<p>如果<code>HashTable</code>非空，就清空<code>ht-&gt;arBuckets</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (ht-&gt;nTableMask) &#123;</div><div class="line">    <span class="built_in">memset</span>(ht-&gt;arBuckets, <span class="number">0</span>, ht-&gt;nTableSize*<span class="keyword">sizeof</span>(Bucket *));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从首元素开始一直清空直至最后</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (p != <span class="literal">NULL</span>) &#123;</div><div class="line">    q = p;</div><div class="line">    p = p-&gt;pListNext;</div><div class="line">    <span class="keyword">if</span> (ht-&gt;pDestructor) &#123;</div><div class="line">        ht-&gt;pDestructor(q-&gt;pData);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (q-&gt;pData != &amp;q-&gt;pDataPtr) &#123;</div><div class="line">        pefree(q-&gt;pData, ht-&gt;persistent);</div><div class="line">    &#125;</div><div class="line">    pefree(q, ht-&gt;persistent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="增删查改"><a href="#增删查改" class="headerlink" title="增删查改"></a>增删查改</h3><p>声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* additions/updates/changes */</span></div><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_add_or_update(HashTable *ht, <span class="keyword">const</span> <span class="keyword">char</span> *arKey, uint nKeyLength, <span class="keyword">void</span> *pData, uint nDataSize, <span class="keyword">void</span> **pDest, <span class="keyword">int</span> flag ZEND_FILE_LINE_DC);</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zend_hash_update(ht, arKey, nKeyLength, pData, nDataSize, pDest) \</span></div><div class="line">        _zend_hash_add_or_update(ht, arKey, nKeyLength, pData, nDataSize, pDest, HASH_UPDATE ZEND_FILE_LINE_CC)</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zend_hash_add(ht, arKey, nKeyLength, pData, nDataSize, pDest) \</span></div><div class="line">        _zend_hash_add_or_update(ht, arKey, nKeyLength, pData, nDataSize, pDest, HASH_ADD ZEND_FILE_LINE_CC)</div><div class="line"></div><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_quick_add_or_update(HashTable *ht, <span class="keyword">const</span> <span class="keyword">char</span> *arKey, uint nKeyLength, ulong h, <span class="keyword">void</span> *pData, uint nDataSize, <span class="keyword">void</span> **pDest, <span class="keyword">int</span> flag ZEND_FILE_LINE_DC);</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zend_hash_quick_update(ht, arKey, nKeyLength, h, pData, nDataSize, pDest) \</span></div><div class="line">        _zend_hash_quick_add_or_update(ht, arKey, nKeyLength, h, pData, nDataSize, pDest, HASH_UPDATE ZEND_FILE_LINE_CC)</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zend_hash_quick_add(ht, arKey, nKeyLength, h, pData, nDataSize, pDest) \</span></div><div class="line">        _zend_hash_quick_add_or_update(ht, arKey, nKeyLength, h, pData, nDataSize, pDest, HASH_ADD ZEND_FILE_LINE_CC)</div><div class="line"></div><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_index_update_or_next_insert(HashTable *ht, ulong h, <span class="keyword">void</span> *pData, uint nDataSize, <span class="keyword">void</span> **pDest, <span class="keyword">int</span> flag ZEND_FILE_LINE_DC);</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zend_hash_index_update(ht, h, pData, nDataSize, pDest) \</span></div><div class="line">        _zend_hash_index_update_or_next_insert(ht, h, pData, nDataSize, pDest, HASH_UPDATE ZEND_FILE_LINE_CC)</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zend_hash_next_index_insert(ht, pData, nDataSize, pDest) \</span></div><div class="line">        _zend_hash_index_update_or_next_insert(ht, 0, pData, nDataSize, pDest, HASH_NEXT_INSERT ZEND_FILE_LINE_CC)</div><div class="line"></div><div class="line"><span class="function">ZEND_API <span class="keyword">int</span> <span class="title">zend_hash_add_empty_element</span><span class="params">(HashTable *ht, <span class="keyword">const</span> <span class="keyword">char</span> *arKey, uint nKeyLength)</span></span>;</div></pre></td></tr></table></figure>
<p>其实可以看到，一共只有四个函数，其他的都是宏定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_add_or_update(HashTable *ht, <span class="keyword">const</span> <span class="keyword">char</span> *arKey, uint nKeyLength, <span class="keyword">void</span> *pData, uint nDataSize, <span class="keyword">void</span> **pDest, <span class="keyword">int</span> flag ZEND_FILE_LINE_DC);</div><div class="line"></div><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_quick_add_or_update(HashTable *ht, <span class="keyword">const</span> <span class="keyword">char</span> *arKey, uint nKeyLength, ulong h, <span class="keyword">void</span> *pData, uint nDataSize, <span class="keyword">void</span> **pDest, <span class="keyword">int</span> flag ZEND_FILE_LINE_DC);</div><div class="line"></div><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_index_update_or_next_insert(HashTable *ht, ulong h, <span class="keyword">void</span> *pData, uint nDataSize, <span class="keyword">void</span> **pDest, <span class="keyword">int</span> flag ZEND_FILE_LINE_DC);</div><div class="line"></div><div class="line"><span class="function">ZEND_API <span class="keyword">int</span> <span class="title">zend_hash_add_empty_element</span><span class="params">(HashTable *ht, <span class="keyword">const</span> <span class="keyword">char</span> *arKey, uint nKeyLength)</span></span>;</div></pre></td></tr></table></figure>
<p>先看<code>_zend_hash_add_or_update</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_add_or_update(HashTable *ht, <span class="keyword">const</span> <span class="keyword">char</span> *arKey, uint nKeyLength, <span class="keyword">void</span> *pData, uint nDataSize, <span class="keyword">void</span> **pDest, <span class="keyword">int</span> flag ZEND_FILE_LINE_DC)</div><div class="line">&#123;</div><div class="line">    ulong h;</div><div class="line">    uint nIndex;</div><div class="line">    Bucket *p;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ZEND_SIGNALS</span></div><div class="line">    TSRMLS_FETCH();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    IS_CONSISTENT(ht);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (nKeyLength &lt;= <span class="number">0</span>) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_DEBUG</span></div><div class="line">        ZEND_PUTS(<span class="string">"zend_hash_update: Can't put in empty key\n"</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">        <span class="keyword">return</span> FAILURE;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    CHECK_INIT(ht);</div><div class="line"></div><div class="line">    h = zend_inline_hash_func(arKey, nKeyLength);</div><div class="line">    nIndex = h &amp; ht-&gt;nTableMask;</div><div class="line"></div><div class="line">    p = ht-&gt;arBuckets[nIndex];</div><div class="line">    <span class="keyword">while</span> (p != <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (p-&gt;arKey == arKey ||</div><div class="line">            ((p-&gt;h == h) &amp;&amp; (p-&gt;nKeyLength == nKeyLength) &amp;&amp; !<span class="built_in">memcmp</span>(p-&gt;arKey, arKey, nKeyLength))) &#123;</div><div class="line">                <span class="keyword">if</span> (flag &amp; HASH_ADD) &#123;</div><div class="line">                    <span class="keyword">return</span> FAILURE;</div><div class="line">                &#125;</div><div class="line">                HANDLE_BLOCK_INTERRUPTIONS();</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_DEBUG</span></div><div class="line">                <span class="keyword">if</span> (p-&gt;pData == pData) &#123;</div><div class="line">                    ZEND_PUTS(<span class="string">"Fatal error in zend_hash_update: p-&gt;pData == pData\n"</span>);</div><div class="line">                    HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line">                    <span class="keyword">return</span> FAILURE;</div><div class="line">                &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">                <span class="keyword">if</span> (ht-&gt;pDestructor) &#123;</div><div class="line">                    ht-&gt;pDestructor(p-&gt;pData);</div><div class="line">                &#125;</div><div class="line">                UPDATE_DATA(ht, p, pData, nDataSize);</div><div class="line">                <span class="keyword">if</span> (pDest) &#123;</div><div class="line">                    *pDest = p-&gt;pData;</div><div class="line">                &#125;</div><div class="line">                HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line">                <span class="keyword">return</span> SUCCESS;</div><div class="line">        &#125;</div><div class="line">        p = p-&gt;pNext;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (IS_INTERNED(arKey)) &#123;</div><div class="line">        p = (Bucket *) pemalloc(<span class="keyword">sizeof</span>(Bucket), ht-&gt;persistent);</div><div class="line">        <span class="keyword">if</span> (!p) &#123;</div><div class="line">            <span class="keyword">return</span> FAILURE;</div><div class="line">        &#125;</div><div class="line">        p-&gt;arKey = arKey;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        p = (Bucket *) pemalloc(<span class="keyword">sizeof</span>(Bucket) + nKeyLength, ht-&gt;persistent);</div><div class="line">        <span class="keyword">if</span> (!p) &#123;</div><div class="line">            <span class="keyword">return</span> FAILURE;</div><div class="line">        &#125;</div><div class="line">        p-&gt;arKey = (<span class="keyword">const</span> <span class="keyword">char</span>*)(p + <span class="number">1</span>);</div><div class="line">        <span class="built_in">memcpy</span>((<span class="keyword">char</span>*)p-&gt;arKey, arKey, nKeyLength);</div><div class="line">    &#125;</div><div class="line">    p-&gt;nKeyLength = nKeyLength;</div><div class="line">    INIT_DATA(ht, p, pData, nDataSize);</div><div class="line">    p-&gt;h = h;</div><div class="line">    CONNECT_TO_BUCKET_DLLIST(p, ht-&gt;arBuckets[nIndex]);</div><div class="line">    <span class="keyword">if</span> (pDest) &#123;</div><div class="line">        *pDest = p-&gt;pData;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    HANDLE_BLOCK_INTERRUPTIONS();</div><div class="line">    CONNECT_TO_GLOBAL_DLLIST(p, ht);</div><div class="line">    ht-&gt;arBuckets[nIndex] = p;</div><div class="line">    HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line"></div><div class="line">    ht-&gt;nNumOfElements++;</div><div class="line">    ZEND_HASH_IF_FULL_DO_RESIZE(ht);        <span class="comment">/* If the Hash table is full, resize it */</span></div><div class="line">    <span class="keyword">return</span> SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先计算hash值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">h = zend_inline_hash_func(arKey, nKeyLength);</div><div class="line">nIndex = h &amp; ht-&gt;nTableMask;</div></pre></td></tr></table></figure>
<p>然后判断计算出来的<code>nIndex</code>是否已经有数据，如果已经有数据并且当前操作是<code>update</code>的话，就更新，否则就返回失败</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">while</span> (p != <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (p-&gt;arKey == arKey ||</div><div class="line">            ((p-&gt;h == h) &amp;&amp; (p-&gt;nKeyLength == nKeyLength) &amp;&amp; !<span class="built_in">memcmp</span>(p-&gt;arKey, arKey, nKeyLength))) &#123;</div><div class="line">                <span class="keyword">if</span> (flag &amp; HASH_ADD) &#123;</div><div class="line">                    <span class="keyword">return</span> FAILURE;</div><div class="line">                &#125;</div><div class="line">                HANDLE_BLOCK_INTERRUPTIONS();</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_DEBUG</span></div><div class="line">                <span class="keyword">if</span> (p-&gt;pData == pData) &#123;</div><div class="line">                    ZEND_PUTS(<span class="string">"Fatal error in zend_hash_update: p-&gt;pData == pData\n"</span>);</div><div class="line">                    HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line">                    <span class="keyword">return</span> FAILURE;</div><div class="line">                &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">                <span class="keyword">if</span> (ht-&gt;pDestructor) &#123;</div><div class="line">                    ht-&gt;pDestructor(p-&gt;pData);</div><div class="line">                &#125;</div><div class="line">                UPDATE_DATA(ht, p, pData, nDataSize);</div><div class="line">                <span class="keyword">if</span> (pDest) &#123;</div><div class="line">                    *pDest = p-&gt;pData;</div><div class="line">                &#125;</div><div class="line">                HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line">                <span class="keyword">return</span> SUCCESS;</div><div class="line">        &#125;</div><div class="line">        p = p-&gt;pNext;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>接下来是<code>add</code>操作部分的逻辑</p>
<p>首先分配内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (IS_INTERNED(arKey)) &#123;</div><div class="line">    p = (Bucket *) pemalloc(<span class="keyword">sizeof</span>(Bucket), ht-&gt;persistent);</div><div class="line">    <span class="keyword">if</span> (!p) &#123;</div><div class="line">        <span class="keyword">return</span> FAILURE;</div><div class="line">    &#125;</div><div class="line">    p-&gt;arKey = arKey;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    p = (Bucket *) pemalloc(<span class="keyword">sizeof</span>(Bucket) + nKeyLength, ht-&gt;persistent);</div><div class="line">    <span class="keyword">if</span> (!p) &#123;</div><div class="line">        <span class="keyword">return</span> FAILURE;</div><div class="line">    &#125;</div><div class="line">    p-&gt;arKey = (<span class="keyword">const</span> <span class="keyword">char</span>*)(p + <span class="number">1</span>);</div><div class="line">    <span class="built_in">memcpy</span>((<span class="keyword">char</span>*)p-&gt;arKey, arKey, nKeyLength);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化相应的结构然后赋值，<code>CONNECT_TO_BUCKET_DLLIST</code>保存在<code>buckets</code>链表里，然后使用<code>CONNECT_TO_GLOBAL_DLLIST(p, ht)</code>将新结构保存在<code>HashTable</code>的<code>pListTail</code>，最后作为<code>bucktes</code>的头元素保存在<code>ht-&gt;arBuckets[nIndex]</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">p-&gt;nKeyLength = nKeyLength;</div><div class="line">INIT_DATA(ht, p, pData, nDataSize);</div><div class="line">p-&gt;h = h;</div><div class="line">CONNECT_TO_BUCKET_DLLIST(p, ht-&gt;arBuckets[nIndex]);</div><div class="line"><span class="keyword">if</span> (pDest) &#123;</div><div class="line">    *pDest = p-&gt;pData;</div><div class="line">&#125;</div><div class="line"></div><div class="line">HANDLE_BLOCK_INTERRUPTIONS();</div><div class="line">CONNECT_TO_GLOBAL_DLLIST(p, ht);</div><div class="line">ht-&gt;arBuckets[nIndex] = p;</div><div class="line">HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line"></div><div class="line">ht-&gt;nNumOfElements++;</div><div class="line">ZEND_HASH_IF_FULL_DO_RESIZE(ht);        <span class="comment">/* If the Hash table is full, resize it */</span></div><div class="line"><span class="keyword">return</span> SUCCESS;</div></pre></td></tr></table></figure>
<p>接下来看<code>_zend_hash_quick_add_or_update</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_quick_add_or_update(HashTable *ht, <span class="keyword">const</span> <span class="keyword">char</span> *arKey, uint nKeyLength, ulong h, <span class="keyword">void</span> *pData, uint nDataSize, <span class="keyword">void</span> **pDest, <span class="keyword">int</span> flag ZEND_FILE_LINE_DC)</div><div class="line">&#123;</div><div class="line">    uint nIndex;</div><div class="line">    Bucket *p;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ZEND_SIGNALS</span></div><div class="line">    TSRMLS_FETCH();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    IS_CONSISTENT(ht);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (nKeyLength == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> zend_hash_index_update(ht, h, pData, nDataSize, pDest);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    CHECK_INIT(ht);</div><div class="line">    nIndex = h &amp; ht-&gt;nTableMask;</div><div class="line">    </div><div class="line">    p = ht-&gt;arBuckets[nIndex];</div><div class="line">    <span class="keyword">while</span> (p != <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (p-&gt;arKey == arKey ||</div><div class="line">            ((p-&gt;h == h) &amp;&amp; (p-&gt;nKeyLength == nKeyLength) &amp;&amp; !<span class="built_in">memcmp</span>(p-&gt;arKey, arKey, nKeyLength))) &#123;</div><div class="line">                <span class="keyword">if</span> (flag &amp; HASH_ADD) &#123;</div><div class="line">                    <span class="keyword">return</span> FAILURE;</div><div class="line">                &#125;</div><div class="line">                HANDLE_BLOCK_INTERRUPTIONS();</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_DEBUG</span></div><div class="line">                <span class="keyword">if</span> (p-&gt;pData == pData) &#123;</div><div class="line">                    ZEND_PUTS(<span class="string">"Fatal error in zend_hash_update: p-&gt;pData == pData\n"</span>);</div><div class="line">                    HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line">                    <span class="keyword">return</span> FAILURE;</div><div class="line">                &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">                <span class="keyword">if</span> (ht-&gt;pDestructor) &#123;</div><div class="line">                    ht-&gt;pDestructor(p-&gt;pData);</div><div class="line">                &#125;</div><div class="line">                UPDATE_DATA(ht, p, pData, nDataSize);</div><div class="line">                <span class="keyword">if</span> (pDest) &#123;</div><div class="line">                    *pDest = p-&gt;pData;</div><div class="line">                &#125;</div><div class="line">                HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line">                <span class="keyword">return</span> SUCCESS;</div><div class="line">        &#125;</div><div class="line">        p = p-&gt;pNext;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (IS_INTERNED(arKey)) &#123;</div><div class="line">        p = (Bucket *) pemalloc(<span class="keyword">sizeof</span>(Bucket), ht-&gt;persistent);</div><div class="line">        <span class="keyword">if</span> (!p) &#123;</div><div class="line">            <span class="keyword">return</span> FAILURE;</div><div class="line">        &#125;</div><div class="line">        p-&gt;arKey = arKey;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        p = (Bucket *) pemalloc(<span class="keyword">sizeof</span>(Bucket) + nKeyLength, ht-&gt;persistent);</div><div class="line">        <span class="keyword">if</span> (!p) &#123;</div><div class="line">            <span class="keyword">return</span> FAILURE;</div><div class="line">        &#125;</div><div class="line">        p-&gt;arKey = (<span class="keyword">const</span> <span class="keyword">char</span>*)(p + <span class="number">1</span>);</div><div class="line">        <span class="built_in">memcpy</span>((<span class="keyword">char</span>*)p-&gt;arKey, arKey, nKeyLength);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    p-&gt;nKeyLength = nKeyLength;</div><div class="line">    INIT_DATA(ht, p, pData, nDataSize);</div><div class="line">    p-&gt;h = h;</div><div class="line">    </div><div class="line">    CONNECT_TO_BUCKET_DLLIST(p, ht-&gt;arBuckets[nIndex]);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pDest) &#123;</div><div class="line">        *pDest = p-&gt;pData;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    HANDLE_BLOCK_INTERRUPTIONS();</div><div class="line">    ht-&gt;arBuckets[nIndex] = p;</div><div class="line">    CONNECT_TO_GLOBAL_DLLIST(p, ht);</div><div class="line">    HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line"></div><div class="line">    ht-&gt;nNumOfElements++;</div><div class="line">    ZEND_HASH_IF_FULL_DO_RESIZE(ht);        <span class="comment">/* If the Hash table is full, resize it */</span></div><div class="line">    <span class="keyword">return</span> SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个<code>_zend_hash_quick_add_or_update</code>多了一个参数：<code>ulong h</code>，免去了计算<code>hash</code>的过程</p>
<p>下面看<code>_zend_hash_index_update_or_next_insert</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">ZEND_API <span class="keyword">int</span> _zend_hash_index_update_or_next_insert(HashTable *ht, ulong h, <span class="keyword">void</span> *pData, uint nDataSize, <span class="keyword">void</span> **pDest, <span class="keyword">int</span> flag ZEND_FILE_LINE_DC)</div><div class="line">&#123;</div><div class="line">    uint nIndex;</div><div class="line">    Bucket *p;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ZEND_SIGNALS</span></div><div class="line">    TSRMLS_FETCH();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    IS_CONSISTENT(ht);</div><div class="line">    CHECK_INIT(ht);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (flag &amp; HASH_NEXT_INSERT) &#123;</div><div class="line">        h = ht-&gt;nNextFreeElement;</div><div class="line">    &#125;</div><div class="line">    nIndex = h &amp; ht-&gt;nTableMask;</div><div class="line"></div><div class="line">    p = ht-&gt;arBuckets[nIndex];</div><div class="line">    <span class="keyword">while</span> (p != <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">if</span> ((p-&gt;nKeyLength == <span class="number">0</span>) &amp;&amp; (p-&gt;h == h)) &#123;</div><div class="line">            <span class="keyword">if</span> (flag &amp; HASH_NEXT_INSERT || flag &amp; HASH_ADD) &#123;</div><div class="line">                <span class="keyword">return</span> FAILURE;</div><div class="line">            &#125;</div><div class="line">            HANDLE_BLOCK_INTERRUPTIONS();</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_DEBUG</span></div><div class="line">            <span class="keyword">if</span> (p-&gt;pData == pData) &#123;</div><div class="line">                ZEND_PUTS(<span class="string">"Fatal error in zend_hash_index_update: p-&gt;pData == pData\n"</span>);</div><div class="line">                HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line">                <span class="keyword">return</span> FAILURE;</div><div class="line">            &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">            <span class="keyword">if</span> (ht-&gt;pDestructor) &#123;</div><div class="line">                ht-&gt;pDestructor(p-&gt;pData);</div><div class="line">            &#125;</div><div class="line">            UPDATE_DATA(ht, p, pData, nDataSize);</div><div class="line">            HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line">            <span class="keyword">if</span> ((<span class="keyword">long</span>)h &gt;= (<span class="keyword">long</span>)ht-&gt;nNextFreeElement) &#123;</div><div class="line">                ht-&gt;nNextFreeElement = h &lt; LONG_MAX ? h + <span class="number">1</span> : LONG_MAX;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (pDest) &#123;</div><div class="line">                *pDest = p-&gt;pData;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> SUCCESS;</div><div class="line">        &#125;</div><div class="line">        p = p-&gt;pNext;</div><div class="line">    &#125;</div><div class="line">    p = (Bucket *) pemalloc_rel(<span class="keyword">sizeof</span>(Bucket), ht-&gt;persistent);</div><div class="line">    <span class="keyword">if</span> (!p) &#123;</div><div class="line">        <span class="keyword">return</span> FAILURE;</div><div class="line">    &#125;</div><div class="line">    p-&gt;arKey = <span class="literal">NULL</span>;</div><div class="line">    p-&gt;nKeyLength = <span class="number">0</span>; <span class="comment">/* Numeric indices are marked by making the nKeyLength == 0 */</span></div><div class="line">    p-&gt;h = h;</div><div class="line">    INIT_DATA(ht, p, pData, nDataSize);</div><div class="line">    <span class="keyword">if</span> (pDest) &#123;</div><div class="line">        *pDest = p-&gt;pData;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    CONNECT_TO_BUCKET_DLLIST(p, ht-&gt;arBuckets[nIndex]);</div><div class="line"></div><div class="line">    HANDLE_BLOCK_INTERRUPTIONS();</div><div class="line">    ht-&gt;arBuckets[nIndex] = p;</div><div class="line">    CONNECT_TO_GLOBAL_DLLIST(p, ht);</div><div class="line">    HANDLE_UNBLOCK_INTERRUPTIONS();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((<span class="keyword">long</span>)h &gt;= (<span class="keyword">long</span>)ht-&gt;nNextFreeElement) &#123;</div><div class="line">        ht-&gt;nNextFreeElement = h &lt; LONG_MAX ? h + <span class="number">1</span> : LONG_MAX;</div><div class="line">    &#125;</div><div class="line">    ht-&gt;nNumOfElements++;</div><div class="line">    ZEND_HASH_IF_FULL_DO_RESIZE(ht);</div><div class="line">    <span class="keyword">return</span> SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该函数用于不指定<code>hash</code>插入元素时，如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$a = <span class="keyword">array</span>(<span class="number">10</span> =&gt; <span class="string">'Hello'</span>);</div><div class="line">$a[] = <span class="string">'TIPI'</span>;</div></pre></td></tr></table></figure>
<p>也用于指定<code>hash</code>插入元素时，函数名里的<code>next_insert</code>用于第一种情况，<code>index_update</code>则用于第二种情况。</p>
<p>函数通过<code>flag</code>变量来判断调用场景，如果是<code>next_insert</code>，则从<code>ht-&gt;nNextFreeElement</code>获取下一个可用的<code>hash</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (flag &amp; HASH_NEXT_INSERT) &#123;</div><div class="line">    h = ht-&gt;nNextFreeElement;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下的流程就跟<code>_zend_hash_add_or_update</code>一样</p>
<p>接下来看<code>zend_hash_add_empty_element</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function">ZEND_API <span class="keyword">int</span> <span class="title">zend_hash_add_empty_element</span><span class="params">(HashTable *ht, <span class="keyword">const</span> <span class="keyword">char</span> *arKey, uint nKeyLength)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">void</span> *dummy = (<span class="keyword">void</span> *) <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> zend_hash_add(ht, arKey, nKeyLength, &amp;dummy, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *), <span class="literal">NULL</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>添加一个<code>(void *) 1</code>的空元素</p>
<h2 id="HashTable-in-PHP-7"><a href="#HashTable-in-PHP-7" class="headerlink" title="HashTable in PHP 7"></a>HashTable in PHP 7</h2><p>在<code>PHP 7</code>里，<code>Bucket</code>和<code>HashTable</code>的定义发生了很大的变化，首先看<code>Bucket</code>和<code>HashTable</code>:</p>
<p><code>/Zend/zend_types.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _Bucket &#123;</div><div class="line">    zval              val;</div><div class="line">    zend_ulong        h;                <span class="comment">/* hash value (or numeric index)   */</span></div><div class="line">    zend_string      *key;              <span class="comment">/* string key or NULL for numerics */</span></div><div class="line">&#125; Bucket;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _zend_array HashTable;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> _zend_array &#123;</div><div class="line">    zend_refcounted_h gc;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            ZEND_ENDIAN_LOHI_4(</div><div class="line">                zend_uchar    flags,</div><div class="line">                zend_uchar    nApplyCount,</div><div class="line">                zend_uchar    nIteratorsCount,</div><div class="line">                zend_uchar    reserve)</div><div class="line">        &#125; v;</div><div class="line">        <span class="keyword">uint32_t</span> flags;</div><div class="line">    &#125; u;</div><div class="line">    <span class="keyword">uint32_t</span>          nTableMask;</div><div class="line">    Bucket           *arData;</div><div class="line">    <span class="keyword">uint32_t</span>          nNumUsed;</div><div class="line">    <span class="keyword">uint32_t</span>          nNumOfElements;</div><div class="line">    <span class="keyword">uint32_t</span>          nTableSize;</div><div class="line">    <span class="keyword">uint32_t</span>          nInternalPointer;</div><div class="line">    zend_long         nNextFreeElement;</div><div class="line">    <span class="keyword">dtor_func_t</span>       pDestructor;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>和<code>PHP 5</code>里的<code>Bucket</code>相比，<code>PHP 7</code>里的<code>Bucket</code>删除了许多字段：</p>
<p><code>PHP 5</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> bucket &#123;</div><div class="line">    ulong h;                        <span class="comment">/* Used for numeric indexing */</span></div><div class="line">    uint nKeyLength;</div><div class="line">    <span class="keyword">void</span> *pData;</div><div class="line">    <span class="keyword">void</span> *pDataPtr;</div><div class="line">    <span class="keyword">struct</span> bucket *pListNext;</div><div class="line">    <span class="keyword">struct</span> bucket *pListLast;</div><div class="line">    <span class="keyword">struct</span> bucket *pNext;</div><div class="line">    <span class="keyword">struct</span> bucket *pLast;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *arKey;</div><div class="line">&#125; Bucket;</div></pre></td></tr></table></figure>
<p>在<code>PHP 7</code>中，<code>Bucket</code>精简到只剩三个字段</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _Bucket &#123;</div><div class="line">    zval              val;</div><div class="line">    zend_ulong        h;                <span class="comment">/* hash value (or numeric index)   */</span></div><div class="line">    zend_string      *key;              <span class="comment">/* string key or NULL for numerics */</span></div><div class="line">&#125; Bucket;</div></pre></td></tr></table></figure>
<p>以前由<code>Bucket</code>负责处理<code>Hash</code>冲突，维护冲突链表，现在由<code>zval</code>负责维护冲突链表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> _zval_struct &#123;</div><div class="line">    zend_value        value;            <span class="comment">/* value */</span></div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            ZEND_ENDIAN_LOHI_4(</div><div class="line">                zend_uchar    type,            <span class="comment">/* active type */</span></div><div class="line">                zend_uchar    type_flags,</div><div class="line">                zend_uchar    const_flags,</div><div class="line">                zend_uchar    reserved)        <span class="comment">/* call info for EX(This) */</span></div><div class="line">        &#125; v;</div><div class="line">        <span class="keyword">uint32_t</span> type_info;</div><div class="line">    &#125; u1;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></div><div class="line">        <span class="keyword">uint32_t</span>     cache_slot;           <span class="comment">/* literal cache slot */</span></div><div class="line">        <span class="keyword">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></div><div class="line">        <span class="keyword">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></div><div class="line">        <span class="keyword">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></div><div class="line">        <span class="keyword">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></div><div class="line">        <span class="keyword">uint32_t</span>     access_flags;         <span class="comment">/* class constant access flags */</span></div><div class="line">        <span class="keyword">uint32_t</span>     property_guard;       <span class="comment">/* single property guard */</span></div><div class="line">    &#125; u2;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中<code>_zval_struct.u2.next</code>就是冲突链表指针</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/01/18/准备写点什么/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 <a href="http://ztz.me">ztz</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>